<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Discord Auth</title>
</head>
<body>
  <h3>Connexion en cours...</h3>
  <script>
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    const token = params.get('access_token');

    if (!token) {
      document.body.innerHTML = "<h3 style='color:red'>Ã‰chec.</h3>";
      setTimeout(() => window.close(), 2000);
      return;
    }

    fetch('https://discord.com/api/users/@me', {
      headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(res => res.ok ? res.json() : Promise.reject())
    .then(user => {
      window.opener.postMessage({
        type: 'DISCORD_AUTH',
        username: user.username,
        id: user.id
      }, '*');
      document.body.innerHTML = "<h3 style='color:green'>OK !</h3>";
      setTimeout(() => window.close(), 1000);
    })
    .catch(() => {
      document.body.innerHTML = "<h3 style='color:red'>Erreur token.</h3>";
      setTimeout(() => window.close(), 3000);
    });
  </script>
</body>
</html>
